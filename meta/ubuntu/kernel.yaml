name: pi-universal-wifi
mmdebstrap:
  architectures:
    - arm64
  packages:
    - firmware-brcm80211
    - initramfs-tools
    - iw
    - network-manager
    - dnsmasq-base
    - hostapd

  customize-hooks:
    # ===== Install ROS Real-Time Kernel packages =====
    - cp kernel/RPI4/linux-headers-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb $1/root/
    - cp kernel/RPI4/linux-image-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb $1/root/
    - cp kernel/RPI4/linux-libc-dev_6.8.4-g75867ff0890f-1_arm64.deb $1/root/

    - chroot $1 dpkg -i /root/linux-libc-dev_6.8.4-g75867ff0890f-1_arm64.deb /root/linux-image-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb /root/linux-headers-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb

    # Force update/initramfs generation for RT kernel
    - chroot $1 update-initramfs -c -k 6.8.4-rt11-raspi

    # Ensure /boot/firmware directory exists
    - chroot $1 /bin/bash -c 'mkdir -p /boot/firmware'

    # Copy kernel image from known candidates to /boot/firmware/kernel8.img
    - chroot $1 /bin/bash -c 'KERNEL_IMG=""; for f in /boot/Image /boot/Image-6.8.4-rt11-raspi /boot/kernel8.img /boot/vmlinuz-*; do if [ -f "$f" ]; then KERNEL_IMG="$f"; break; fi; done; if [ -n "$KERNEL_IMG" ]; then cp "$KERNEL_IMG" /boot/firmware/kernel8.img; else echo "No kernel image found in /boot" >&2; exit 1; fi'

    # Copy device tree blobs if available
    - chroot $1 /bin/bash -c 'if compgen -G "/boot/*.dtb" > /dev/null; then cp /boot/*.dtb /boot/firmware/; fi'

    # Copy overlays if not already present
    - chroot $1 /bin/bash -c 'if [ ! -d /boot/firmware/overlays ]; then cp -r /boot/overlays /boot/firmware/; fi'

    # Clean up kernel deb packages
    - rm -f $1/root/linux-headers-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb $1/root/linux-image-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb $1/root/linux-libc-dev_6.8.4-g75867ff0890f-1_arm64.deb

dpkgopts:
  - path-include=/usr/lib/raspi-firmware/brcm/*
