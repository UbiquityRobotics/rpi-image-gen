name: pi-universal-rpi-image
mmdebstrap:
  architectures:
    - arm64
  packages:
    - linux-image-raspi  # Install standard kernel first for proper boot infrastructure
    - firmware-brcm80211
    - initramfs-tools
    - iw
    - network-manager
    - dnsmasq-base
    - hostapd

  customize-hooks:
    # ===== Step 1: Create boot/firmware directory structure FIRST =====
    - mkdir -p $1/boot/firmware
    - mkdir -p $1/boot/overlays
    # ===== Firmware Installation =====
    - mkdir -p $1/lib/firmware/brcm
    - install -Dm644 firmware/brcm/cyfmac43455-sdio.* $1/lib/firmware/brcm/
    - install -Dm644 firmware/brcm/brcmfmac43455-sdio.txt $1/lib/firmware/brcm/

    # ===== Device Symlinks =====
    - ln -sf cyfmac43455-sdio.bin $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.bin
    - ln -sf cyfmac43455-sdio.clm_blob $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.clm_blob
    - ln -sf cyfmac43455-sdio.bin $1/lib/firmware/brcm/brcmfmac43455-sdio.bin
    - ln -sf cyfmac43455-sdio.clm_blob $1/lib/firmware/brcm/brcmfmac43455-sdio.clm_blob

    # ===== Step 2: Install base template files for cmdline.txt and config.txt =====
    - install -m 644 $RPI_TEMPLATES/boot-firmware/cmdline.txt $1/boot/firmware/
    - install -m 644 $RPI_TEMPLATES/boot-firmware/config.txt $1/boot/firmware/
    
    # ===== Step 3: Clone and copy Raspberry Pi firmware =====
    - git clone --depth 1 https://github.com/raspberrypi/firmware.git /tmp/rpi-firmware
    - cp -r /tmp/rpi-firmware/boot/* $1/boot/firmware/
    - cp -r /tmp/rpi-firmware/boot/overlays/* $1/boot/overlays/
    - cp -r /tmp/rpi-firmware/modules/* $1/lib/modules/ || true
    - rm -rf /tmp/rpi-firmware

    # ===== Step 4: Install your RT kernel packages =====
    - cp kernel/RPI4/linux-headers-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb $1/root/
    - cp kernel/RPI4/linux-image-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb $1/root/
    - cp kernel/RPI4/linux-libc-dev_6.8.4-g75867ff0890f-1_arm64.deb $1/root/
    - chroot $1 dpkg -i /root/linux-libc-dev_6.8.4-g75867ff0890f-1_arm64.deb /root/linux-image-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb /root/linux-headers-6.8.4-rt11-raspi_6.8.4-g75867ff0890f-1_arm64.deb

    # ===== Step 5: Ensure critical modules for BOTH Pi4 and Pi5 =====
    - |
      chroot $1 /bin/bash -c '
      mkdir -p /etc/initramfs-tools
      touch /etc/initramfs-tools/modules
      
      # Pi 5 MMC/SD drivers
      echo "bcm2835-mmc" >> /etc/initramfs-tools/modules
      echo "sdhci-bcm2835" >> /etc/initramfs-tools/modules
      
      # Pi 4 MMC/SD drivers
      echo "sdhci_iproc" >> /etc/initramfs-tools/modules
      echo "bcm2835_dma" >> /etc/initramfs-tools/modules
      echo "sdhci" >> /etc/initramfs-tools/modules
      
      # Common storage modules
      echo "mmc_block" >> /etc/initramfs-tools/modules
      echo "mmc_core" >> /etc/initramfs-tools/modules
      echo "ext4" >> /etc/initramfs-tools/modules
      echo "usb_storage" >> /etc/initramfs-tools/modules
      echo "uas" >> /etc/initramfs-tools/modules
      
      # Update MODULES setting in existing config (preserve other settings)
      sed -i "s/^MODULES=.*/MODULES=most/" /etc/initramfs-tools/initramfs.conf
      # Ensure COMPRESS is set if not present
      grep -q "^COMPRESS=" /etc/initramfs-tools/initramfs.conf || echo "COMPRESS=gzip" >> /etc/initramfs-tools/initramfs.conf
      '
    # ===== Step 6: Generate initramfs for RT kernel with required modules =====
    - chroot $1 update-initramfs -c -k 6.8.4-rt11-raspi

    # ===== Step 7: Clean old firmware kernel files =====
    - chroot $1 /bin/bash -c 'rm -f /boot/firmware/kernel*.img /boot/firmware/vmlinuz* /boot/firmware/Image*'

    # ===== Step 8: Copy RT kernel image AS THE LAST step =====
    - |
      chroot $1 /bin/bash -c '
      KERNEL_IMG=""
      for f in /boot/Image-6.8.4-rt11-raspi /boot/vmlinuz-6.8.4-rt11-raspi /boot/Image /boot/kernel8.img; do
        if [ -f "$f" ]; then
          KERNEL_IMG="$f"
          break
        fi
      done
      if [ -n "$KERNEL_IMG" ]; then
        cp "$KERNEL_IMG" /boot/firmware/kernel8.img
        echo "Copied kernel: $KERNEL_IMG to /boot/firmware/kernel8.img"
      else
        echo "No kernel image found" >&2
        exit 1
      fi
      '

    # ===== Step 9: Copy initramfs to boot partition =====
    - |
      chroot $1 /bin/bash -c '
      if [ -f /boot/initrd.img-6.8.4-rt11-raspi ]; then
        cp /boot/initrd.img-6.8.4-rt11-raspi /boot/firmware/initrd.img
        echo "Copied initramfs to /boot/firmware/initrd.img"
      else
        echo "Warning: initramfs not found for RT kernel" >&2
      fi
      '

    # ===== Step 10: Copy device trees from their installed locations to /boot/firmware =====
    - |
      chroot $1 /bin/bash -c '
      # Copy main DTBs
      cp /usr/lib/linux-image-6.8.4-rt11-raspi/broadcom/*.dtb /boot/firmware/

      # Copy overlays
      cp /usr/lib/linux-image-6.8.4-rt11-raspi/overlays/*.dtbo /boot/overlays/

      # Explicitly copy Pi4 device tree if available (now from correct path)
      if [ -f /usr/lib/linux-image-6.8.4-rt11-raspi/broadcom/bcm2711-rpi-4-b.dtb ]; then
        cp /usr/lib/linux-image-6.8.4-rt11-raspi/broadcom/bcm2711-rpi-4-b.dtb /boot/firmware/
        echo "Copied Pi4 DTB"
      fi

      # Remove duplicate copy-all-DTBs logic
      '
    # ===== Step 11: Fix config.txt for both Pi4 and Pi5 =====
    - |
      cp "$1/boot/firmware/config.txt" "$1/boot/firmware/config.txt.backup"
      
      # Remove old sections
      sed -i '/^\[pi4\]/,/^\[/{/^\[pi4\]/d; /^\[/!d; /^\[/i\
      }' "$1/boot/firmware/config.txt"
      sed -i '/^\[pi5\]/,/^\[/{/^\[pi5\]/d; /^\[/!d; /^\[/i\
      }' "$1/boot/firmware/config.txt"
      sed -i 's/^dtoverlay=disable-bt/#dtoverlay=disable-bt/' "$1/boot/firmware/config.txt"
      
      cat >> "$1/boot/firmware/config.txt" << 'EOF'

      [all]
      # Load initramfs for all Pi models
      initramfs initrd.img followkernel
      
      [pi4]
      kernel=kernel8.img
      enable_uart=1
      dtoverlay=disable-bt
      dtoverlay=uart0
      dtoverlay=uart1,pin_tx=32,pin_rx=33
      dtoverlay=uart2
      # Pi4 specific settings
      arm_64bit=1
      
      [pi5]
      kernel=kernel8.img
      BOOT_UART=1
      dtoverlay=disable-bt
      dtoverlay=uart0
      dtoverlay=uart1
      dtoverlay=uart2
      dtoverlay=uart3-pi5
      dtoverlay=uart4
      dtoverlay=uart5

      # Camera settings (if needed)
      camera_auto_detect=0
      start_x=1
      display_auto_detect=1
      dtoverlay=imx219
      camera_auto_detect=1
      EOF

    # ===== Step 12: Modify cmdline.txt to use device path (most reliable for testing) =====
    - |
      sed -i 's|\broot=[^ ]*||g; s|rootfstype=[^ ]*||g; s|rootwait||g' "$1/boot/firmware/cmdline.txt"
      sed -i 's/  */ /g' "$1/boot/firmware/cmdline.txt"
      sed -i 's|$| root=/dev/mmcblk0p2 rootfstype=ext4 rootwait|' "$1/boot/firmware/cmdline.txt"
      sed -i 's/^ *//; s/ *$//' "$1/boot/firmware/cmdline.txt"

    # ===== Step 13: Firmware symlinks for wireless driver =====
    - ln -sf brcmfmac43455-sdio.bin $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.bin
    - ln -sf brcmfmac43455-sdio.clm_blob $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.clm_blob

    # ===== Step 14: Legacy boot notices =====
    - |
      for f in cmdline.txt config.txt; do
        printf "DO NOT EDIT THIS FILE\n\nThe file you are looking for has moved to /boot/firmware/%s\n" "$f" > "$1/boot/$f"
      done

    # ===== Step 15: Clean kernel packages from root to save space =====
    - rm -f $1/root/linux-headers-6.8.4-rt11-raspi_*_arm64.deb $1/root/linux-image-6.8.4-rt11-raspi_*_arm64.deb $1/root/linux-libc-dev_6.8.4-g75867ff0890f-1_arm64.deb
    
    
    # ===== Enhanced NVRAM Configuration =====
    - |
      cat <<EOF >> $1/lib/firmware/brcm/brcmfmac43455-sdio.txt
      boardflags3=0x44200100
      sromrev=11
      xtalfreq=40000
      boardtype=0x0e00
      boardrev=0x1100
      EOF

    # ===== Regulatory Domain Setup =====
    - mkdir -p $1/etc/regulatory
    - echo "country=US" > $1/etc/regulatory/regulatory.db
    - chmod 644 $1/etc/regulatory/regulatory.db

    # ===== Kernel Parameters =====
    - sed -i 's/$/ brcmfmac.run_oob=1 brcmfmac.htavail_timeout=1000000 cfg80211.ieee80211_regdom=US/' $1/boot/firmware/cmdline.txt

    # ===== SSH Performance Optimization =====
    - |
      cat <<EOF >> $1/etc/ssh/sshd_config
      # Performance optimizations
      UseDNS no
      GSSAPIAuthentication no
      IPQoS cs0 cs0
      EOF

    # ===== PAM Optimization for Low-Resource Devices =====
    - |
      sed -i 's/session\s*optional\s*pam_systemd.so/#&/' $1/etc/pam.d/common-session
      sed -i 's/session\s*optional\s*pam_chksshpwd.so/#&/' $1/etc/pam.d/common-session

    # ===== NetworkManager Configuration =====
    - |
      cat <<EOF > $1/etc/NetworkManager/conf.d/ap-optimized.conf
      [connection]
      match-device=interface-name:wlan0
      ipv4.dhcp-timeout=5
      ipv4.may-fail=no
      
      [main]
      dns=dnsmasq
      dhcp=internal
      EOF

    # ===== Dynamic Hostname Setup Script =====
    - |
      cat <<EOF > $1/usr/local/bin/setup-hostname.sh
      #!/bin/bash
      # Get last 4 digits of wlan0 MAC address
      MAC_SUFFIX=\$(cat /sys/class/net/wlan0/address | tr -d ':' | tail -c 5 | tr '[:lower:]' '[:upper:]')
      NEW_HOSTNAME="ubiquityrobot\${MAC_SUFFIX}"
      
      # Set hostname if different from current
      if [ "\$(hostname)" != "\${NEW_HOSTNAME}" ]; then
          echo "\${NEW_HOSTNAME}" > /etc/hostname
          sed -i "s/127.0.1.1.*/127.0.1.1\t\${NEW_HOSTNAME}/" /etc/hosts
          hostnamectl set-hostname "\${NEW_HOSTNAME}"
      fi
      EOF
      chmod +x $1/usr/local/bin/setup-hostname.sh

    # ===== Enhanced Access Point Setup Script =====
    - |
      cat <<EOF > $1/usr/local/bin/setup-ap.sh
      #!/bin/bash
      set -e
      
      # Exit if already configured
      if [ -f /etc/accesspoint-configured ]; then
          exit 0
      fi
      
      # Wait for NetworkManager to be fully ready
      sleep 5
      
      # Wait for wlan0 interface (up to 30 seconds)
      for i in {1..30}; do
          if [ -e /sys/class/net/wlan0/address ]; then
              echo "wlan0 interface found"
              break
          fi
          echo "Waiting for wlan0 interface... (\$i/30)"
          sleep 1
      done
      
      # Setup hostname based on MAC
      /usr/local/bin/setup-hostname.sh
      
      # Get hostname for SSID
      HOSTNAME=\$(hostname)
      
      # Set regulatory domain
      iw reg set US 2>/dev/null || true
      
      # Remove any existing AP connections
      nmcli con delete ap 2>/dev/null || true
      
      # Configure access point with explicit error handling
      if nmcli con add type wifi ifname wlan0 con-name ap \
          autoconnect yes \
          ssid "\${HOSTNAME}" \
          802-11-wireless.mode ap \
          802-11-wireless.channel 6 \
          802-11-wireless.band bg \
          ipv4.method shared \
          ipv4.addresses 192.168.0.1/24 \
          wifi-sec.key-mgmt wpa-psk \
          wifi-sec.psk "robotseverywhere"; then
          
          echo "AP connection created successfully"
          
          # Enable connection with retry logic
          for i in {1..5}; do
              if nmcli con up ap; then
                  echo "AP activated successfully"
                  break
              fi
              echo "Retry \$i/5: Failed to activate AP, retrying in 3 seconds..."
              sleep 3
          done
      else
          echo "Failed to create AP connection"
          exit 1
      fi
      
      # Create marker file with proper permissions
      touch /etc/accesspoint-configured
      chmod 644 /etc/accesspoint-configured
      
      echo "Access Point configured with SSID: \${HOSTNAME}"
      EOF
      chmod +x $1/usr/local/bin/setup-ap.sh

    # ===== Hostname Setup Service =====
    - |
      cat <<EOF > $1/etc/systemd/system/setup-hostname.service
      [Unit]
      Description=Setup Dynamic Hostname from MAC
      Before=network.target
      After=systemd-udev-settle.service
      
      [Service]
      Type=oneshot
      User=root
      ExecStart=/usr/local/bin/setup-hostname.sh
      RemainAfterExit=yes
      
      [Install]
      WantedBy=multi-user.target
      EOF

    # ===== First-Boot AP Service =====
    - |
      cat <<EOF > $1/etc/systemd/system/firstboot-ap.service
      [Unit]
      Description=First-boot Access Point Setup
      After=network.target NetworkManager.service setup-hostname.service
      Wants=setup-hostname.service NetworkManager.service
      ConditionPathExists=!/etc/accesspoint-configured
      
      [Service]
      Type=oneshot
      User=root
      ExecStart=/usr/local/bin/setup-ap.sh
      RemainAfterExit=yes
      Restart=on-failure
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target
      EOF

    # ===== Enable Services =====
    - chroot $1 systemctl enable setup-hostname.service
    - chroot $1 systemctl enable firstboot-ap.service


dpkgopts:
  - path-include=/usr/lib/raspi-firmware/brcm/brcmfmac43455*
  - path-include=/usr/lib/raspi-firmware/LICENCE.broadcom
