name: pi-universal-firmware
mmdebstrap:
  packages:
    - raspi-firmware
  customize-hooks:
    - mkdir -p $1/boot/firmware
    - ln -sf firmware/overlays $1/boot/overlays
    - install -m 644 $RPI_TEMPLATES/boot-firmware/cmdline.txt $1/boot/firmware/
    - install -m 644 $RPI_TEMPLATES/boot-firmware/config.txt $1/boot/firmware/

    # ===== Device Tree Configuration =====
    - |
      # Pi4 Configuration
      printf "\n[pi4]\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=disable-bt\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=uart0\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=uart1\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=uart2\n" >> "$1/boot/firmware/config.txt"

      # Pi5 Configuration
      printf "\n[pi5]\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=uart3-pi5\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=uart4\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=uart5\n" >> "$1/boot/firmware/config.txt"

      # Common UART Configuration
      printf "\n[all]\n" >> "$1/boot/firmware/config.txt"
      printf "enable_uart=1\n" >> "$1/boot/firmware/config.txt"

      # Camera Configuration (applies to all models)
      printf "\n# Camera settings\n" >> "$1/boot/firmware/config.txt"
      printf "camera_auto_detect=0\n" >> "$1/boot/firmware/config.txt"
      printf "start_x=1\n" >> "$1/boot/firmware/config.txt"
      printf "display_auto_detect=1\n" >> "$1/boot/firmware/config.txt"
      printf "dtoverlay=imx219\n" >> "$1/boot/firmware/config.txt"

    # ===== Firmware Symlinks =====
    - ln -sf brcmfmac43455-sdio.bin $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.bin
    - ln -sf brcmfmac43455-sdio.clm_blob $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.clm_blob

    # Legacy boot notices
    - for f in cmdline.txt config.txt; do
        printf "DO NOT EDIT THIS FILE\n\nThe file you are looking for has moved to %s\n" /boot/firmware/$f > $1/boot/$f;
      done

  dpkgopts:
    - path-include=/usr/lib/raspi-firmware/brcm/brcmfmac43455*
    - path-include=/usr/lib/raspi-firmware/LICENCE.broadcom

