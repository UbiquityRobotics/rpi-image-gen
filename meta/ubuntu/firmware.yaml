name: pi-universal-firmware
mmdebstrap:
  packages: []
  customize-hooks:
    - mkdir -p $1/boot/firmware
    - mkdir -p $1/boot/overlays
    - rm -rf $1/boot/overlays/*

    - install -m 644 $RPI_TEMPLATES/boot-firmware/cmdline.txt $1/boot/firmware/
    - install -m 644 $RPI_TEMPLATES/boot-firmware/config.txt $1/boot/firmware/

    # ===== Device Tree Configuration (Enhanced approach) =====
    - |
      # Backup original config
      cp "$1/boot/firmware/config.txt" "$1/boot/firmware/config.txt.backup"

      # Remove all existing [pi4], [pi5], and duplicate [all] sections
      sed -i '/^\[pi4\]/,/^\[/{/^\[pi4\]/d; /^\[/!d; /^\[/i\
      }' "$1/boot/firmware/config.txt"
      sed -i '/^\[pi5\]/,/^\[/{/^\[pi5\]/d; /^\[/!d; /^\[/i\
      }' "$1/boot/firmware/config.txt"
      
      # Comment out any existing dtoverlay=disable-bt lines
      sed -i 's/^dtoverlay=disable-bt/#dtoverlay=disable-bt/' "$1/boot/firmware/config.txt"

      # Add our clean sections at the end
      cat >> "$1/boot/firmware/config.txt" << 'EOF'

      [pi4]
      enable_uart=1
      dtoverlay=disable-bt
      dtoverlay=uart0
      dtoverlay=uart1,pin_tx=32,pin_rx=33
      dtoverlay=uart2

      [pi5]
      BOOT_UART=1
      dtoverlay=disable-bt
      dtoverlay=uart0
      dtoverlay=uart1
      dtoverlay=uart2
      dtoverlay=uart3-pi5
      dtoverlay=uart4
      dtoverlay=uart5

      # Camera settings
      camera_auto_detect=0
      start_x=1
      display_auto_detect=1
      dtoverlay=imx219
      camera_auto_detect=1
      EOF


    # ===== Cmdline.txt modification =====
    - |
      # Remove console=serial0,115200 from the beginning of cmdline.txt if present
      sed -i 's/^console=serial0,115200[[:space:]]*//' "$1/boot/firmware/cmdline.txt"
      # Also remove if it appears anywhere else in the line
      sed -i 's/[[:space:]]console=serial0,115200//g' "$1/boot/firmware/cmdline.txt"

    # ===== Firmware Symlinks =====
    - ln -sf brcmfmac43455-sdio.bin $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.bin
    - ln -sf brcmfmac43455-sdio.clm_blob $1/lib/firmware/brcm/brcmfmac43455-sdio.raspberrypi,model-b-2712.clm_blob

    # ===== Copy firmware overlays to both firmware and boot paths =====
    - git clone --depth 1 https://github.com/raspberrypi/firmware.git /tmp/rpi-firmware
    - cp -r /tmp/rpi-firmware/boot/* $1/boot/firmware/
    - cp -r /tmp/rpi-firmware/boot/overlays/* $1/boot/overlays/
    - cp -r /tmp/rpi-firmware/modules/* $1/lib/modules/ || true
    - rm -rf /tmp/rpi-firmware

    # Legacy boot notices
    - |
      for f in cmdline.txt config.txt; do
        printf "DO NOT EDIT THIS FILE\n\nThe file you are looking for has moved to /boot/firmware/%s\n" "$f" > "$1/boot/$f"
      done

dpkgopts:
  - path-include=/usr/lib/raspi-firmware/brcm/brcmfmac43455*
  - path-include=/usr/lib/raspi-firmware/LICENCE.broadcom
